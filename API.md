# FrontendInsight API

This document describes the public HTTP API exposed by the FrontendInsight Nextcloud app.

Base path: `/apps/frontend_insight`

All endpoints respond with JSON unless otherwise noted. Authentication is handled by Nextcloud; some endpoints are marked as PublicPage and do not require an authenticated session.

## Routes summary
- GET `/client.js` – Serves the browser client script (Content-Type: text/javascript)
- POST `/report/error` – Accepts error reports from browsers (PublicPage, rate limited)
- GET `/api/1.0/events` – Returns a paginated list of recorded events (CORS enabled)
- GET `/api/1.0/stats` – Returns aggregate stats (latest event time, counts per type) (CORS enabled)
- OPTIONS `/api/1.0/{path}` – CORS preflight for API endpoints

## GET /client.js
- Description: Returns the compiled client bundle that instruments the browser to report errors.
- Method: GET
- Auth: PublicPage (no auth required)
- Response: text/javascript
- Notes:
  - The script is generated by the build pipeline and injected with app name and report URL at runtime.

## POST /report/error
- Description: Reports a client-side error to the server for storage.
- Method: POST
- Auth: PublicPage (no auth required)
- Rate limiting:
  - Authenticated users: 20 requests per 60 seconds
  - Anonymous users: 10 requests per 60 seconds
- Body parameters (form or JSON mapped by Nextcloud):
  - `timestamp` (number, required): Milliseconds since epoch
  - `type` (string, required): Event type, e.g., `error` or `unhandledrejection`
  - `userAgent` (string, required): User agent string
  - `url` (string, required): Page URL where the error occurred
  - `message` (string, optional): Error message
  - `stack` (string, optional): Stack trace
  - `file` (string, optional): File reference, potentially including line/column
- Response: 204 No Content
- Example (curl):
```bash
curl -X POST \
  "https://nextcloud.example.com/apps/frontend_insight/report/error" \
  -H "Content-Type: application/json" \
  -d '{
    "timestamp": 1733250000000,
    "type": "error",
    "userAgent": "Mozilla/5.0 ...",
    "url": "https://nextcloud.example.com/apps/dashboard/",
    "message": "TypeError: ...",
    "stack": "TypeError at ...",
    "file": "app.js:10:42"
  }'
```

## GET /api/1.0/events
- Description: Returns a paginated list of recorded events.
- Method: GET
- Auth: CORS-enabled endpoint, intended for use by the admin UI.
- Query parameters:
  - `url` (string, optional): Filters events whose `url` contains the substring
  - `page` (int, optional, default 0): Page index (0-based)
  - `limit` (int, optional, default 20): Page size
- Response (200):
```json
{
  "limit": 20,
  "page": 0,
  "totalItems": 123,
  "values": [
    {
      "id": 1,
      "timestamp": 1733250000000,
      "type": "error",
      "useragent": "Mozilla/5.0 ...",
      "url": "https://nextcloud.example.com/apps/dashboard/",
      "message": "TypeError: ...",
      "stack": "TypeError at ...",
      "file": "app.js:10:42"
    }
  ]
}
```
- Notes:
  - `useragent` field uses lowercase as persisted in the database entity. The POST `/report/error` accepts `userAgent` (camelCase) and it is mapped to the entity accordingly on the server side.

## OPTIONS /api/1.0/{path}
- Description: CORS preflight endpoint.
- Method: OPTIONS
- Response: 200 OK with appropriate CORS headers supplied by Nextcloud.

## Data model
- Event
  - `id` (number)
  - `timestamp` (number)
  - `type` (string)
  - `useragent` (string)
  - `url` (string)
  - `message` (string|null)
  - `stack` (string|null)
  - `file` (string|null)

## Versioning
- The API path includes a version segment (e.g., `/api/1.0/events`). Future versions may add fields or endpoints under new version segments.

## Security
- CSP is configured by the app to allow loading the client script and any configured external domains.
- The error reporting endpoint is rate-limited and publicly accessible; avoid sending sensitive data in error payloads.
