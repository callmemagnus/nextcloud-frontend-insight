#!/bin/env node

const { glob } = require("glob");
const fs = require("fs");

const APP_NAME = "frontendinsight";

const fileHeader = `/**
 * Don't change this file manually it is generated by the ./bin/extract_translations.cjs script
 * to satisfy Nextcloud's bot as it does not know how to read .svelte files.
 */

// @ts-ignore
const { t, n } = window;
`


async function run() {

  const files = await glob("src/**/*.svelte");

  // Match translate("frontendinsight", "text") or translate('frontendinsight', 'text')
  // Using character class ["\'] to match either single or double quotes
  const translateRegexp = new RegExp(`translate\\(["\']${APP_NAME}["\'],\\s*["\']([^"\']+)["\']`, "mg");

  // Match translatePlural("frontendinsight", "singular", "plural", ...) with either quote style
  const translatePluralRegexp = new RegExp(`translatePlural\\(["\']${APP_NAME}["\'],\\s*["\']([^"\']+)["\'],\\s*["\']([^"\']+)["\']`, "mg");

  const translations = new Set();
  const pluralTranslations = new Set();

  files.forEach(filepath => {
    console.log(`Grabbing from ${filepath}`);
    const content = fs.readFileSync(filepath, 'utf-8');

    // Extract regular translations
    const translateMatches = content.matchAll(translateRegexp);
    for (const match of translateMatches) {
      translations.add(match[1]);
    }

    // Extract plural translations
    const pluralMatches = content.matchAll(translatePluralRegexp);
    for (const match of pluralMatches) {
      // Add both singular and plural forms
      pluralTranslations.add({ singular: match[1], plural: match[2] });
    }
  });

  console.log(`Found ${translations.size} regular translations`);
  console.log(`Found ${pluralTranslations.size} plural translations`);

  const result = [fileHeader];
  let counter = 0;

  // Sort and add regular translations
  const englishLabels = [...translations];
  englishLabels.sort();

  englishLabels.forEach(translation => {
    result.push(`const label${counter} = t('${APP_NAME}', '${translation.replace(/'/g, "\\'")}');`);
    counter++;
  });

  // Add plural translations
  const pluralLabels = [...pluralTranslations];
  pluralLabels.forEach(({ singular, plural }) => {
    result.push(`const label${counter} = n('${APP_NAME}', '${singular.replace(/'/g, "\\'")}', '${plural.replace(/'/g, "\\'")}', 1);`);
    counter++;
  });

  // Add console.log statements for all labels
  for (let i = 0; i < counter; i++) {
    result.push(`console.log(label${i});`)
  }

  fs.writeFileSync("src/fakeLabels.ts", result.join('\n') + '\n');
  console.log(`Wrote ${counter} translations to src/fakeLabels.ts`);
  console.log('Done')
}

run();